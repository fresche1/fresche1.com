<!DOCTYPE html>
<html lang="es" data-lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Checkout - FRESCHE</title>
    <link rel="stylesheet" href="styles.css?v=20260131">
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <style>
        .checkout-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
        }

        .checkout-section {
            background: rgba(30, 30, 30, 0.95);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 15px;
            padding: 2rem;
        }

        .checkout-section h2 {
            color: var(--gold);
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            color: var(--gold);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            color: #fff;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .order-summary {
            position: sticky;
            top: 2rem;
            height: fit-content;
        }

        .order-item {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(212, 175, 55, 0.2);
        }

        .order-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
        }

        .order-item-info {
            flex: 1;
        }

        .order-item-name {
            color: #fff;
            font-weight: 600;
            margin-bottom: 0.3rem;
        }

        .order-item-quantity {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        .order-item-price {
            color: var(--gold);
            font-weight: bold;
        }

        .order-totals {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid rgba(212, 175, 55, 0.3);
        }

        .order-total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.8rem;
            color: #fff;
        }

        .order-total-row.final {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--gold);
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid var(--gold);
        }

        .btn-pay {
            width: 100%;
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--gold), #ffd700);
            color: #000;
            border: none;
            border-radius: 10px;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 1.5rem;
        }

        .btn-pay:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(212, 175, 55, 0.5);
        }

        .btn-pay:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .payment-methods {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .payment-method {
            padding: 1.2rem;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .payment-method:hover {
            border-color: var(--gold);
            background: rgba(212, 175, 55, 0.1);
        }

        .payment-method.selected {
            border-color: var(--gold);
            background: rgba(212, 175, 55, 0.2);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
        }

        .payment-method-icon {
            font-size: 2.5rem;
        }

        .payment-method-info {
            flex: 1;
        }

        .payment-method-name {
            color: #fff;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.3rem;
        }

        .payment-method-desc {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        .test-mode-banner {
            background: linear-gradient(90deg, #ff9800, #ff5722);
            color: #fff;
            padding: 1rem;
            text-align: center;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .shipping-options {
            display: grid;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .shipping-option {
            padding: 1.2rem;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .shipping-option:hover {
            border-color: var(--gold);
            background: rgba(212, 175, 55, 0.1);
        }

        .shipping-option.selected {
            border-color: var(--gold);
            background: rgba(212, 175, 55, 0.2);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
        }

        .shipping-option-info {
            flex: 1;
        }

        .shipping-option-name {
            color: #fff;
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.3rem;
        }

        .shipping-option-desc {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        .shipping-option-price {
            color: var(--gold);
            font-weight: bold;
            font-size: 1.3rem;
        }

        .shipping-alert {
            background: rgba(255, 152, 0, 0.1);
            border: 1px solid rgba(255, 152, 0, 0.3);
            padding: 1rem;
            border-radius: 8px;
            color: #ff9800;
            margin-bottom: 1rem;
        }

        @media (max-width: 968px) {
            .checkout-container {
                grid-template-columns: 1fr;
            }

            .order-summary {
                position: relative;
                top: 0;
            }
        }
    </style>
</head>
<body>
    <div class="checkout-container">
        <!-- Formulario de Checkout -->
        <div class="checkout-section">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
                <h2 style="margin: 0;" data-es="Informaci√≥n de Pago" data-en="Payment Information">Informaci√≥n de Pago</h2>
                <button type="button" onclick="window.location.href='index.html'" style="padding: 0.7rem 1.5rem; background: rgba(255, 255, 255, 0.1); border: 2px solid var(--gold); border-radius: 8px; color: var(--gold); font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem;" onmouseover="this.style.background='var(--gold)'; this.style.color='#1a1a1a';" onmouseout="this.style.background='rgba(255, 255, 255, 0.1)'; this.style.color='var(--gold)';">
                    <span>‚Üê</span>
                    <span data-es="Regresar al Carrito" data-en="Back to Cart">Regresar al Carrito</span>
                </button>
            </div>
            
            <form id="checkoutForm">
                <!-- Direcci√≥n de Env√≠o -->
                <div id="shippingAddressSection">
                    <h3 style="color: var(--gold); margin: 2rem 0 1rem;">
                        <span data-es="Direcci√≥n de Env√≠o" data-en="Shipping Address">Direcci√≥n de Env√≠o</span>
                    </h3>

                    <div class="form-group">
                        <label data-es="Direcci√≥n *" data-en="Address *">Direcci√≥n *</label>
                        <input type="text" id="address" required placeholder="Calle 123 #45-67">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label data-es="Ciudad *" data-en="City *">Ciudad *</label>
                        <input type="text" id="city" required placeholder="Bogot√°" oninput="updateShippingCost()">
                    </div>
                    <div class="form-group">
                        <label data-es="C√≥digo Postal" data-en="Postal Code">C√≥digo Postal</label>
                        <input type="text" id="postalCode" placeholder="110111">
                    </div>
                </div>

                <div class="form-group">
                    <label data-es="Pa√≠s *" data-en="Country *">Pa√≠s *</label>
                    <select id="country" required onchange="updateShippingCost()">
                        <option value="">Selecciona un pa√≠s</option>
                        <option value="CO">üá®üá¥ Colombia</option>
                        <option value="US">üá∫üá∏ Estados Unidos</option>
                        <option value="CA">üá®üá¶ Canad√°</option>
                        <option value="MX">üá≤üáΩ M√©xico</option>
                        <option value="ES">üá™üá∏ Espa√±a</option>
                        <option value="AR">üá¶üá∑ Argentina</option>
                        <option value="CL">üá®üá± Chile</option>
                        <option value="PE">üáµüá™ Per√∫</option>
                        <option value="EC">üá™üá® Ecuador</option>
                        <option value="BR">üáßüá∑ Brasil</option>
                        <option value="OTHER">üåé Otro pa√≠s</option>
                    </select>
                </div>

                <div class="form-group">
                    <label data-es="Departamento/Estado *" data-en="State *">Departamento/Estado *</label>
                    <input type="text" id="state" required placeholder="Cundinamarca">
                </div>
                </div>

                <!-- Opciones de Env√≠o -->
                <h3 style="color: var(--gold); margin: 2rem 0 1rem;">
                    <span data-es="M√©todo de Env√≠o" data-en="Shipping Method">M√©todo de Env√≠o</span>
                </h3>

                <div id="shippingOptions" class="shipping-options">
                    <!-- Se llenar√°n din√°micamente seg√∫n el pa√≠s -->
                </div>

                <div id="pickupStoreContainer"></div>

                <!-- Datos Personales -->
                <div id="customerInfoSection" style="display: none;">
                    <h3 style="color: var(--gold); margin: 2rem 0 1rem;">
                        <span data-es="Datos del Cliente" data-en="Customer Information">Datos del Cliente</span>
                    </h3>
                    <div class="form-group">
                        <label data-es="Nombre Completo *" data-en="Full Name *">Nombre Completo *</label>
                        <input type="text" id="fullName" required placeholder="Juan P√©rez">
                    </div>

                    <div class="form-group">
                        <label data-es="Email *" data-en="Email *">Email *</label>
                        <input type="email" id="email" required placeholder="tu@email.com">
                    </div>

                    <div class="form-group">
                        <label data-es="Tel√©fono *" data-en="Phone *">Tel√©fono *</label>
                        <input type="tel" id="phone" required placeholder="+57 300 123 4567">
                    </div>
                </div>

                <div class="shipping-alert" style="margin-top: 0.75rem;">
                    <span data-es="En Colombia, de 1 a 10 cremas el env√≠o tiene el mismo costo." data-en="In Colombia, ordering 1 to 10 creams keeps the same shipping cost.">En Colombia, de 1 a 10 cremas el env√≠o tiene el mismo costo.</span>
                </div>

                <!-- M√©todo de Pago -->
                <h3 style="color: var(--gold); margin: 2rem 0 1rem;">
                    <span data-es="M√©todo de Pago" data-en="Payment Method">M√©todo de Pago</span>
                </h3>

                <div class="payment-methods" id="paymentMethodsContainer">
                    <div class="payment-method selected" data-method="NEQUI" data-region="CO" onclick="selectPaymentMethod(this)">
                        <div class="payment-method-icon">üì±</div>
                        <div class="payment-method-info">
                            <div class="payment-method-name">Nequi</div>
                            <div class="payment-method-desc">Pago directo sin comisi√≥n</div>
                        </div>
                    </div>
                    <div class="payment-method" data-method="ZELLE" data-region="US" onclick="selectPaymentMethod(this)" style="display:none;">
                        <div class="payment-method-icon">üíµ</div>
                        <div class="payment-method-info">
                            <div class="payment-method-name">Zelle</div>
                            <div class="payment-method-desc">Direct payment - No fees</div>
                        </div>
                    </div>
                    <div class="payment-method" data-method="MERCADOPAGO" data-region="ALL" onclick="selectPaymentMethod(this)">
                        <div class="payment-method-icon">üí≥</div>
                        <div class="payment-method-info">
                            <div class="payment-method-name">Mercado Pago</div>
                            <div class="payment-method-desc" style="color: #ff9800;">+ 5% comisi√≥n</div>
                        </div>
                    </div>
                    <div class="payment-method" data-method="MERCADOLIBRE" data-region="CO" onclick="selectPaymentMethod(this)">
                        <div class="payment-method-icon">üõí</div>
                        <div class="payment-method-info">
                            <div class="payment-method-name">MercadoLibre Colombia</div>
                            <div class="payment-method-desc">Compra directa en ML</div>
                        </div>
                    </div>
                </div>

                <div id="paymentInstructions" style="margin-top: 1.5rem; padding: 1.5rem; background: rgba(212, 175, 55, 0.1); border: 2px solid rgba(212, 175, 55, 0.3); border-radius: 10px;">
                    <!-- Instrucciones de pago din√°micas -->
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="terms" required style="width: auto; margin-right: 0.5rem;">
                        <span data-es="Acepto t√©rminos y condiciones" data-en="I accept terms and conditions">
                            Acepto t√©rminos y condiciones
                        </span>
                    </label>
                </div>
            </form>
        </div>

        <!-- Resumen del Pedido -->
        <div class="order-summary checkout-section">
            <h2 data-es="Resumen del Pedido" data-en="Order Summary">Resumen del Pedido</h2>
            
            <div id="orderItems"></div>

            <div class="order-totals" id="orderTotals" style="display: none;">
                <div class="order-total-row">
                    <span data-es="Subtotal" data-en="Subtotal">Subtotal</span>
                    <span id="subtotal">$0</span>
                </div>
                <div class="order-total-row">
                    <span data-es="Env√≠o" data-en="Shipping">Env√≠o</span>
                    <span id="shipping">$10.000 COP</span>
                </div>
                <div class="order-total-row final">
                    <span data-es="Total" data-en="Total">Total</span>
                    <span id="total">$0</span>
                </div>
            </div>
            
            <!-- Mensaje pendiente de env√≠o (sin subrayado rojo) -->
            <div id="shippingPendingMessage" style="margin: 1.5rem 0; padding: 1.2rem; background: rgba(212, 175, 55, 0.10); border-radius: 12px; border: 2px solid rgba(212, 175, 55, 0.25); text-align: center; color: var(--gold); font-size: 1.15rem; font-weight: 600; box-shadow: 0 2px 16px 0 rgba(212,175,55,0.08);">
                <span style="font-size: 2rem; display: block; margin-bottom: 0.5rem;">üì¶</span>
                <span data-es="Complete la informaci√≥n de env√≠o para ver el total" data-en="Complete shipping information to see total">Complete la informaci√≥n de env√≠o para ver el total</span>
            </div>

            <button class="btn-pay" onclick="processPayment()">
                <span data-es="üîí Pagar Ahora" data-en="üîí Pay Now">üîí Pagar Ahora</span>
            </button>

            <!-- Mensaje de pago seguro (subrayado verde, m√°s grande y elegante) -->
            <div style="margin-top: 1.5rem; padding: 1.5rem; background: linear-gradient(135deg, rgba(0,184,148,0.18) 0%, rgba(212,175,55,0.10) 100%); border-radius: 14px; border: 2.5px solid #00b894; font-size: 1.15rem; color: #fff; box-shadow: 0 4px 24px 0 rgba(0,184,148,0.10); display: flex; align-items: center; gap: 1.2rem; justify-content: center;">
                <span style="font-size: 2.2rem; color: #00b894; font-weight: bold; text-shadow: 0 2px 12px rgba(0,184,148,0.15);">üîí</span>
                <span style="color: #00ffb0; font-size: 1.25rem; font-weight: 700; letter-spacing: 0.5px; text-shadow: 0 2px 12px rgba(0,184,148,0.10);">Pago Seguro</span>
                <span style="color: var(--gold); font-size: 1.1rem; font-weight: 500;">Transacci√≥n procesada por Mercado Pago, plataforma l√≠der de pagos en Am√©rica Latina.</span>
            </div>
        </div>
    </div>

    <script>
        let cart = [];
        let selectedPaymentMethod = 'NEQUI';
        let selectedShippingMethod = null;
        let shippingCost = 0;
        let pickupStore = null; // CO o US para pickup
        let currentCurrency = 'COP'; // Moneda por defecto
        const BACKEND_URL = 'https://fresche1-com.onrender.com';

        // Tarifas de env√≠o reales
        // Colombia: Interrapid√≠simo seg√∫n zona
        // Internacional: Servientrega tarifa fija
        // Zonas de env√≠o desde Bogot√°: LOCAL, REGIONAL, NACIONAL
        const colombiaCities = {
            // LOCAL: Bogot√° y Sabana (Cundinamarca cercana)
            bogota: [
                'bogota', 'bogot√°', 'soacha', 'chia', 'ch√≠a', 'cajica', 'cajic√°', 'cota', 'funza', 'mosquera', 
                'madrid', 'zipaquira', 'zipaquir√°', 'facatativa', 'facatativ√°', 'tocancipa', 'tocancip√°', 
                'tenjo', 'tabio', 'subachoque', 'el rosal', 'siberia', 'siber√≠a', 'gachancipa', 'gachancip√°',
                'sop√≥', 'sopo', 'la calera', 'guasca', 'sesquil√©', 'sesquile', 'nemoc√≥n', 'nemocon',
                'bojaca', 'bojac√°', 'arbelaez', 'arbel√°ez', 'fusagasuga', 'fusagasug√°', 'girardot'
            ],
            // REGIONAL: Principales ciudades y departamentos cercanos (Tolima, Boyac√°, Santanderes, Eje Cafetero, Valle, Antioquia)
            central: [
                // Antioquia
                'medellin', 'medell√≠n', 'envigado', 'bello', 'itagui', 'itag√º√≠', 'sabaneta', 'rionegro', 
                'la estrella', 'caldas', 'copacabana', 'marinilla',
                // Valle del Cauca
                'cali', 'palmira', 'buenaventura', 'tulua', 'tulu√°', 'cartago', 'buga', 'jamundi', 'jamund√≠', 'yumbo',
                // Costa Atl√°ntica
                'barranquilla', 'cartagena', 'santa marta', 'soledad', 'malambo', 'sabanalarga',
                // Santanderes
                'bucaramanga', 'floridablanca', 'giron', 'gir√≥n', 'piedecuesta', 'cucuta', 'c√∫cuta', 
                'pamplona', 'villa del rosario', 'los patios', 'oca√±a', 'barrancabermeja',
                // Eje Cafetero
                'pereira', 'dosquebradas', 'manizales', 'armenia', 'cartago', 'la virginia',
                // Tolima
                'ibague', 'ibagu√©', 'espinal', 'melgar', 'honda',
                // Boyac√°
                'tunja', 'duitama', 'sogamoso', 'chiquinquira', 'chiquinquir√°', 'paipa', 'villa de leyva',
                // Huila
                'neiva', 'pitalito', 'garzon', 'garz√≥n', 'la plata',
                // Meta
                'villavicencio', 'acacias', 'granada', 'puerto lopez', 'puerto l√≥pez'
            ]
            // NACIONAL (larga distancia): Todas las dem√°s ciudades
            // Ejemplos: Leticia, Mit√∫, San Andr√©s, Arauca, Yopal, Mocoa, etc.
        };
        
        function getColombiaCityZone(city) {
            const cityLower = city.toLowerCase().trim();
            if (colombiaCities.bogota.some(c => cityLower.includes(c))) return 'bogota';
            if (colombiaCities.central.some(c => cityLower.includes(c))) return 'central';
            return 'longdistance';
        }
        
        const shippingRates = {
            CO: [
                { id: 'pickup', name: 'üè¢ <span data-es="Recoger en tienda" data-en="Pickup">Recoger en tienda</span>', desc: '<span data-es="Sin cobro extra. Solo pagas el valor del paquete o crema." data-en="No extra charge. Only pay for the product.">Sin cobro extra. Solo pagas el valor del paquete o crema.</span>', price: 0, currency: 'COP', zone: 'pickup' },
                { id: 'bogota', name: 'üè† LOCAL - Bogot√° y Sabana', desc: '2-4 d√≠as h√°biles', price: 9000, currency: 'COP', zone: 'bogota' },
                { id: 'central', name: 'üöö REGIONAL - Colombia Central', desc: '3-5 d√≠as h√°biles', price: 13800, currency: 'COP', zone: 'central' },
                { id: 'longdistance', name: '‚úàÔ∏è NACIONAL - Larga Distancia', desc: '4-7 d√≠as h√°biles', price: 21000, currency: 'COP', zone: 'longdistance' }
            ],
            INTERNATIONAL: [
                { id: 'pickup', name: 'üè¢ <span data-es="Recoger en tienda" data-en="Pickup">Recoger en tienda</span>', desc: '<span data-es="Sin cobro extra. Solo pagas el valor del paquete o crema." data-en="No extra charge. Only pay for the product.">Sin cobro extra. Solo pagas el valor del paquete o crema.</span>', price: 0, currency: 'USD', zone: 'pickup' },
                { id: 'international', name: 'Servientrega International', desc: '10-15 business days', price: 10, currency: 'USD' }
            ]
        };

        // Tabla de precios din√°micos por cantidad (en d√≥lares)
        const priceTable = {
            1: { USD: 18.99, COP: 29900 },
            2: { USD: 34.99, COP: 55000 },
            3: { USD: 44.99, COP: 79000 },
            'pack_elella': { USD: 69.99, COP: 129999 }  // Pack El y Ella (5 unidades)
        };

        // Funci√≥n para obtener precio seg√∫n cantidad y tipo de producto o pack
        function getPricePerUnit(quantity, itemType, packType = null) {
            // Si es un pack, usar el tipo de pack para el precio correcto
            if (itemType === 'pack') {
                if (packType === 'duo') return priceTable[2];
                if (packType === 'trio') return priceTable[3];
                if (packType === 'elella') return priceTable['pack_elella'];
                // fallback
                return priceTable[quantity] || priceTable[1];
            }
            // Para productos normales, retornar tabla seg√∫n cantidad
            if (priceTable[quantity]) {
                return priceTable[quantity];
            }
            // Si la cantidad no est√° en tabla, usar precio base
            return priceTable[1];
        }

        // Pa√≠ses que usan USD
        const usdCountries = ['US', 'CA', 'ES', 'OTHER'];
        


        // Cargar carrito
        function loadCart() {
            const savedCart = localStorage.getItem('freshCart');
            if (savedCart) {
                cart = JSON.parse(savedCart);
            }

            if (cart.length === 0) {
                window.location.href = 'index.html';
                return;
            }

            // Detectar idioma actual
            const language = document.documentElement.lang || 'es';
            
            // Establecer pa√≠s por defecto Colombia
            document.getElementById('country').value = 'CO';
            
            // Si est√° en ingl√©s, cambiar a USD autom√°ticamente
            if (language === 'en') {
                currentCurrency = 'USD';
            } else {
                currentCurrency = 'COP';
            }

            // Mostrar de inmediato las opciones de env√≠o seg√∫n el pa√≠s por defecto
            updateShippingCost();
            displayOrderSummary();
        }

        function displayOrderSummary() {
            const orderItemsDiv = document.getElementById('orderItems');
            const language = document.documentElement.lang || 'es';
            
            // Detectar si est√° en ingl√©s o si detectamos ubicaci√≥n internacional
            let useUSD = (currentCurrency === 'USD');
            const isEnglish = language === 'en';
            
            // Si est√° en ingl√©s, cambiar a USD autom√°ticamente
            if (isEnglish && currentCurrency === 'COP') {
                currentCurrency = 'USD';
                useUSD = true;
            }
            
            // Verificar si se ha completado la informaci√≥n de env√≠o
            const country = document.getElementById('country').value;
            const city = document.getElementById('city').value;
            const address = document.getElementById('address').value;
            const state = document.getElementById('state').value;
            
            const shippingInfoComplete = country && city && address && state && selectedShippingMethod;
            

            // Agrupar productos individuales (no packs)
            let individualUnits = 0;
            let individualItems = [];
            let packItems = [];
            cart.forEach(item => {
                if (item.type === 'pack') {
                    packItems.push(item);
                } else {
                    individualUnits += item.quantity;
                    individualItems.push(item);
                }
            });

            // Calcular subtotal de productos individuales (precio escalonado por total de unidades)
            let subtotal = 0;
            let individualPrice = getPricePerUnit(individualUnits, 'product');
            let individualSubtotal = individualPrice ? (individualPrice[currentCurrency] * individualUnits) : 0;
            subtotal += individualSubtotal;

            // Calcular subtotal de packs
            let packSubtotal = 0;
            packItems.forEach(item => {
                const packType = item.packType || (item.products && item.products.length === 2 ? 'duo' : item.products && item.products.length === 3 ? 'trio' : item.products && item.products.length === 5 ? 'elella' : null);
                let prices = getPricePerUnit(1, 'pack', packType);
                packSubtotal += prices[currentCurrency] * item.quantity;
            });
            subtotal += packSubtotal;

            // Renderizar productos en el resumen
            let itemsHtml = '';
            if (individualUnits > 0) {
                // Mostrar todos los productos individuales agrupados
                let names = individualItems.map(i => i.name).join(', ');
                let img = individualItems[0]?.image || 'images/cherry.jpg';
                let formattedPrice = shippingInfoComplete ? (currentCurrency === 'USD' ? `$${individualSubtotal.toFixed(2)} USD` : `$${Math.round(individualSubtotal).toLocaleString('es-CO')} COP`) : '-';
                itemsHtml += `
                    <div class="order-item">
                        <img src="${img}" alt="Cremas FRESCHE">
                        <div class="order-item-info">
                            <div class="order-item-name">${names}</div>
                            <div class="order-item-quantity">Cantidad: ${individualUnits}</div>
                        </div>
                        <div class="order-item-price">${formattedPrice}</div>
                    </div>
                `;
            }
            packItems.forEach(item => {
                const packType = item.packType || (item.products && item.products.length === 2 ? 'duo' : item.products && item.products.length === 3 ? 'trio' : item.products && item.products.length === 5 ? 'elella' : null);
                let prices = getPricePerUnit(1, 'pack', packType);
                let itemTotal = prices[currentCurrency] * item.quantity;
                let itemName = `${item.name} (${item.products.map(p => p.id).join(', ')})`;
                let itemImage = 'images/cherry.jpg';
                let formattedPrice = shippingInfoComplete ? (currentCurrency === 'USD' ? `$${itemTotal.toFixed(2)} USD` : `$${Math.round(itemTotal).toLocaleString('es-CO')} COP`) : '-';
                itemsHtml += `
                    <div class="order-item">
                        <img src="${itemImage}" alt="${itemName}">
                        <div class="order-item-info">
                            <div class="order-item-name">${itemName}</div>
                            <div class="order-item-quantity">Cantidad: ${item.quantity}</div>
                        </div>
                        <div class="order-item-price">${formattedPrice}</div>
                    </div>
                `;
            });

            orderItemsDiv.innerHTML = itemsHtml;

            const total = subtotal + shippingCost;

            const formatMoney = (amount) => {
                if (currentCurrency === 'USD') {
                    return `$${amount.toFixed(2)} USD`;
                } else {
                    return `$${Math.round(amount).toLocaleString('es-CO')} COP`;
                }
            };

            // Solo mostrar valores si la informaci√≥n de env√≠o est√° completa
            if (shippingInfoComplete) {
                document.getElementById('subtotal').textContent = formatMoney(subtotal);
                document.getElementById('shipping').textContent = formatMoney(shippingCost);
                document.getElementById('total').textContent = formatMoney(total);
                // Mostrar totales y ocultar mensaje pendiente
                document.getElementById('orderTotals').style.display = 'block';
                document.getElementById('shippingPendingMessage').style.display = 'none';
            } else {
                // Ocultar totales y mostrar mensaje pendiente
                document.getElementById('orderTotals').style.display = 'none';
                document.getElementById('shippingPendingMessage').style.display = 'block';
            }
        }

        function updateShippingCost() {
            const country = document.getElementById('country').value;
            const city = document.getElementById('city').value;
            const shippingOptionsDiv = document.getElementById('shippingOptions');
            const language = document.documentElement.lang || 'es';
            const isEnglish = language === 'en';

            if (!country) {
                const alertMsg = isEnglish ? 'Select a country to see shipping options' : 'Selecciona un pa√≠s para ver las opciones de env√≠o';
                shippingOptionsDiv.innerHTML = `<div class="shipping-alert">‚ö†Ô∏è ${alertMsg}</div>`;
                shippingCost = 0;
                selectedShippingMethod = null;
                currentCurrency = (isEnglish || country !== 'CO') ? 'USD' : 'COP';
                displayOrderSummary();
                return;
            }

            // Determinar moneda
            if (selectedShippingMethod === 'pickup') {
                if (pickupStore === 'US') {
                    currentCurrency = 'USD';
                } else if (pickupStore === 'CO') {
                    currentCurrency = 'COP';
                } else {
                    currentCurrency = 'COP';
                }
            } else {
                currentCurrency = country === 'CO' ? 'COP' : 'USD';
            }
            
            // Mostrar/ocultar m√©todos de pago seg√∫n el pa√≠s (si no es pickup)
            if (selectedShippingMethod !== 'pickup') {
                updatePaymentMethods(country);
            }

            let options;
            let selectedOption = null;
            

            // Mostrar opci√≥n Pickup universal
            let html = '';
            const pickupSelected = selectedShippingMethod === 'pickup';
            html += `<div class="shipping-option${pickupSelected ? ' selected' : ''}" data-method="pickup" onclick="selectShippingMethod('pickup', 0)">
                <div class="shipping-option-info">
                    <div class="shipping-option-name">üè¢ <span data-es="Recoger en tienda" data-en="Pickup">Recoger en tienda</span></div>
                    <div class="shipping-option-desc">üì¶ <span data-es="Sin cobro extra. Solo pagas el valor del paquete o crema." data-en="No extra charge. Only pay for the product.">Sin cobro extra. Solo pagas el valor del paquete o crema.</span></div>
                </div>
                <div class="shipping-option-price">$0</div>
            </div>`;

            // Opciones normales de env√≠o
            if (country === 'CO' && selectedShippingMethod !== 'pickup') {
                if (city) {
                    const zone = getColombiaCityZone(city);
                    selectedOption = shippingRates.CO.find(opt => opt.zone === zone);
                    if (selectedOption) {
                        selectedShippingMethod = selectedOption.id;
                        shippingCost = selectedOption.price;
                        const formattedPrice = `$${Math.round(selectedOption.price).toLocaleString('es-CO')} COP`;
                        const zoneName = zone === 'bogota' ? 'üè† LOCAL (Bogot√°)' : zone === 'central' ? 'üöö REGIONAL (Colombia Central)' : '‚úàÔ∏è NACIONAL (Larga Distancia)';
                        html += `<div class="shipping-option selected" data-method="${selectedOption.id}">
                            <div class="shipping-option-info">
                                <div class="shipping-option-name">${selectedOption.name}</div>
                                <div class="shipping-option-desc">üì¶ ${selectedOption.desc}</div>
                                <div style="font-size: 0.9rem; color: var(--gold); margin-top: 0.5rem;">‚úì Zona detectada: ${zoneName}</div>
                            </div>
                            <div class="shipping-option-price">${formattedPrice}</div>
                        </div>`;
                    }
                } else {
                    const alertMsg = isEnglish ? 'Enter a city to calculate shipping cost' : 'Ingresa la ciudad para calcular el costo de env√≠o';
                    html += `<div class="shipping-alert">‚ö†Ô∏è ${alertMsg}</div>`;
                }
            } else if (country !== 'CO' && selectedShippingMethod !== 'pickup') {
                options = shippingRates.INTERNATIONAL;
                selectedOption = options.find(opt => opt.id === 'international');
                if (selectedOption) {
                    selectedShippingMethod = selectedOption.id;
                    shippingCost = selectedOption.price;
                    const formattedPrice = `$${selectedOption.price.toFixed(2)} USD`;
                    html += `<div class="shipping-option selected" data-method="${selectedOption.id}">
                        <div class="shipping-option-info">
                            <div class="shipping-option-name">${selectedOption.name}</div>
                            <div class="shipping-option-desc">üì¶ ${selectedOption.desc}</div>
                        </div>
                        <div class="shipping-option-price">${formattedPrice}</div>
                    </div>`;
                }
            }
            shippingOptionsDiv.innerHTML = html;
            if (selectedShippingMethod === 'pickup') shippingCost = 0;

            if (selectedShippingMethod === 'pickup') {
                renderPickupStoreSelector();
                updatePickupPaymentMethods();
            } else {
                renderPickupStoreSelector();
            }

            displayOrderSummary();
            updateCustomerInfoVisibility();
        }

        function updatePaymentMethods(country) {
            const nequiMethod = document.querySelector('[data-method="NEQUI"]');
            const zelleMethod = document.querySelector('[data-method="ZELLE"]');
            const mercadolibreMethod = document.querySelector('[data-method="MERCADOLIBRE"]');
            const mercadopagoMethod = document.querySelector('[data-method="MERCADOPAGO"]');

            if (country === 'CO') {
                // Solo m√©todos de pago Colombia
                if (nequiMethod) nequiMethod.style.display = 'flex';
                if (zelleMethod) zelleMethod.style.display = 'none';
                if (mercadopagoMethod) mercadopagoMethod.style.display = 'flex';
                if (mercadolibreMethod) mercadolibreMethod.style.display = 'flex';
                if (selectedPaymentMethod === 'ZELLE') {
                    if (nequiMethod) selectPaymentMethod(nequiMethod);
                }
            } else if (country === 'US') {
                // Solo m√©todos de pago USA
                if (nequiMethod) nequiMethod.style.display = 'none';
                if (zelleMethod) zelleMethod.style.display = 'flex';
                if (mercadopagoMethod) mercadopagoMethod.style.display = 'none';
                if (mercadolibreMethod) mercadolibreMethod.style.display = 'none';
                if (selectedPaymentMethod !== 'ZELLE') {
                    if (zelleMethod) selectPaymentMethod(zelleMethod);
                }
            } else {
                // Internacional normal: solo Zelle y MercadoPago
                if (nequiMethod) nequiMethod.style.display = 'none';
                if (zelleMethod) zelleMethod.style.display = 'flex';
                if (mercadopagoMethod) mercadopagoMethod.style.display = 'flex';
                if (mercadolibreMethod) mercadolibreMethod.style.display = 'none';
                if (selectedPaymentMethod === 'NEQUI' || selectedPaymentMethod === 'MERCADOLIBRE') {
                    if (zelleMethod) selectPaymentMethod(zelleMethod);
                    else if (mercadopagoMethod) selectPaymentMethod(mercadopagoMethod);
                }
            }
        }

        function selectShippingMethod(methodId, price) {
            selectedShippingMethod = methodId;
            shippingCost = price;
            
            // Actualizar visualmente
            document.querySelectorAll('.shipping-option').forEach(el => el.classList.remove('selected'));
            const targetOption = (typeof event !== 'undefined' && event.target)
                ? event.target.closest('.shipping-option')
                : document.querySelector(`.shipping-option[data-method="${methodId}"]`);
            if (targetOption) {
                targetOption.classList.add('selected');
            }
            
            // Mostrar/ocultar campos de direcci√≥n seg√∫n si es pickup
            const addressSection = document.getElementById('shippingAddressSection');
            const addressField = document.getElementById('address');
            const cityField = document.getElementById('city');
            const stateField = document.getElementById('state');
            const countryField = document.getElementById('country');
            const postalCodeField = document.getElementById('postalCode');
            
            if (methodId === 'pickup') {
                // Ocultar secci√≥n de direcci√≥n para pickup
                addressSection.style.display = 'none';
                // Hacer campos opcionales
                addressField.removeAttribute('required');
                cityField.removeAttribute('required');
                stateField.removeAttribute('required');
                countryField.removeAttribute('required');
                updateShippingCost();
            } else {
                // Mostrar secci√≥n de direcci√≥n para env√≠o normal
                addressSection.style.display = 'block';
                // Hacer campos requeridos
                addressField.setAttribute('required', 'required');
                cityField.setAttribute('required', 'required');
                stateField.setAttribute('required', 'required');
                countryField.setAttribute('required', 'required');
                updateShippingCost();
            }
            
            // Actualizar resumen
            displayOrderSummary();
        }
        
        function renderPickupStoreSelector() {
            const container = document.getElementById('pickupStoreContainer');
            if (!container) return;

            if (selectedShippingMethod !== 'pickup') {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = `
                <div id="pickupStoreSelector" style="margin:1.5rem 0; padding:1.5rem; background:rgba(212,175,55,0.1); border-radius:12px; border:2px solid var(--gold);">
                    <h4 style="color:var(--gold); margin-bottom:1rem; font-size:1.2rem;">üìç Selecciona la tienda para recoger</h4>
                    <div style="display:flex; gap:1rem; flex-wrap:wrap;">
                        <button type="button" class="pickup-store-btn" data-store="CO" onclick="selectPickupStore('CO')" style="flex:1; min-width:200px; padding:1rem; background:${pickupStore === 'CO' ? 'linear-gradient(135deg, var(--gold), #ffd700)' : 'rgba(255,255,255,0.1)'}; color:${pickupStore === 'CO' ? '#000' : '#fff'}; border:${pickupStore === 'CO' ? '3px solid var(--gold)' : '2px solid rgba(255,255,255,0.3)'}; border-radius:10px; font-size:1.1rem; font-weight:600; cursor:pointer; transition:all 0.3s;">
                            üá®üá¥ Tienda Colombia
                        </button>
                        <button type="button" class="pickup-store-btn" data-store="US" onclick="selectPickupStore('US')" style="flex:1; min-width:200px; padding:1rem; background:${pickupStore === 'US' ? 'linear-gradient(135deg, var(--gold), #ffd700)' : 'rgba(255,255,255,0.1)'}; color:${pickupStore === 'US' ? '#000' : '#fff'}; border:${pickupStore === 'US' ? '3px solid var(--gold)' : '2px solid rgba(255,255,255,0.3)'}; border-radius:10px; font-size:1.1rem; font-weight:600; cursor:pointer; transition:all 0.3s;">
                            üá∫üá∏ Tienda USA
                        </button>
                    </div>
                </div>
            `;
            updateCustomerInfoVisibility();
        }

        function updateCustomerInfoVisibility() {
            const section = document.getElementById('customerInfoSection');
            if (!section) return;
            const shouldShow = selectedShippingMethod && (selectedShippingMethod !== 'pickup' || pickupStore);
            section.style.display = shouldShow ? 'block' : 'none';
        }
        
        function selectPickupStore(store) {
            pickupStore = store;
            currentCurrency = pickupStore === 'US' ? 'USD' : 'COP';
            
            // Actualizar visualmente los botones
            document.querySelectorAll('.pickup-store-btn').forEach(btn => {
                if (btn.dataset.store === store) {
                    btn.style.background = 'linear-gradient(135deg, var(--gold), #ffd700)';
                    btn.style.color = '#000';
                    btn.style.border = '3px solid var(--gold)';
                } else {
                    btn.style.background = 'rgba(255,255,255,0.1)';
                    btn.style.color = '#fff';
                    btn.style.border = '2px solid rgba(255,255,255,0.3)';
                }
            });
            
            // Actualizar m√©todos de pago
            updatePickupPaymentMethods();
            displayOrderSummary();
            updateCustomerInfoVisibility();
        }
        
        function updatePickupPaymentMethods() {
            const container = document.getElementById('paymentMethodsContainer');
            container.innerHTML = '';
            
            if (!pickupStore) {
                container.innerHTML = `
                    <div class="shipping-alert" style="margin-top: 0.75rem;">
                        <span data-es="Selecciona la tienda para ver m√©todos de pago." data-en="Select the store to see payment methods.">Selecciona la tienda para ver m√©todos de pago.</span>
                    </div>
                `;
                const instructionsDiv = document.getElementById('paymentInstructions');
                if (instructionsDiv) instructionsDiv.innerHTML = '';
                return;
            }

            if (pickupStore === 'US') {
                // Solo Zelle para USA
                container.innerHTML = `
                    <div class="payment-method selected" data-method="ZELLE" onclick="selectPaymentMethod(this)">
                        <div class="payment-method-icon">üíµ</div>
                        <div class="payment-method-info">
                            <div class="payment-method-name">Zelle</div>
                            <div class="payment-method-desc">Direct payment - No fees</div>
                        </div>
                    </div>
                `;
                selectedPaymentMethod = 'ZELLE';
            } else {
                // Nequi y transferencia bancaria para Colombia
                container.innerHTML = `
                    <div class="payment-method selected" data-method="NEQUI" onclick="selectPaymentMethod(this)">
                        <div class="payment-method-icon">üì±</div>
                        <div class="payment-method-info">
                            <div class="payment-method-name">Nequi</div>
                            <div class="payment-method-desc">Pago directo sin comisi√≥n</div>
                        </div>
                    </div>
                    <div class="payment-method" data-method="BANCOLOMBIA" onclick="selectPaymentMethod(this)">
                        <div class="payment-method-icon">üè¶</div>
                        <div class="payment-method-info">
                            <div class="payment-method-name">Bancolombia</div>
                            <div class="payment-method-desc">Transferencia bancaria</div>
                        </div>
                    </div>
                `;
                selectedPaymentMethod = 'NEQUI';
            }
            
            // Trigger para mostrar instrucciones
            const firstMethod = container.querySelector('.payment-method.selected');
            if (firstMethod) {
                selectPaymentMethod(firstMethod);
            }
        }

        function selectPaymentMethod(element) {
            document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedPaymentMethod = element.dataset.method;

            const instructionsDiv = document.getElementById('paymentInstructions');
            let instructions = '';

            if (selectedPaymentMethod === 'NEQUI') {
                instructions = `
                    <h4 style="color: var(--gold); margin-bottom: 1rem;">üì± Pago por Nequi</h4>
                    <div style="color: #fff; line-height: 1.8;">
                        <p style="margin-bottom: 0.5rem;"><strong>N√∫mero Nequi:</strong> <span style="color: var(--gold); font-size: 1.2rem;">+57 301 760 6723</span></p>
                        <p style="margin-bottom: 0.5rem;"><strong>A nombre de:</strong> Alejandra Vela Moreno</p>
                        <p style="color: #ff9800; margin-top: 1rem;">‚ö†Ô∏è Despu√©s del pago, haz clic en "Pagar Ahora" para enviar el comprobante al WhatsApp +57 301 760 6723</p>
                    </div>
                `;
            } else if (selectedPaymentMethod === 'ZELLE') {
                const formatMoney = (amount) => {
                    if (currentCurrency === 'USD') {
                        return `$${amount.toFixed(2)} USD`;
                    }
                    return `$${Math.round(amount).toLocaleString('es-CO')} COP`;
                };

                const subtotal = cart.reduce((sum, item) => {
                    let prices;
                    if (item.type === 'pack') {
                        const packType = item.packType || (item.products && item.products.length === 2 ? 'duo' : item.products && item.products.length === 3 ? 'trio' : item.products && item.products.length === 5 ? 'elella' : null);
                        prices = getPricePerUnit(1, 'pack', packType);
                    } else {
                        prices = getPricePerUnit(item.quantity, 'product');
                    }
                    return sum + (prices[currentCurrency] * item.quantity);
                }, 0);

                const total = subtotal + shippingCost;
                instructions = `
                    <h4 style="color: var(--gold); margin-bottom: 1rem;">üíµ Zelle Payment</h4>
                    <div style="color: #fff; line-height: 1.8; text-align:center;">
                        <img src="images/zelle-qr.jpg?v=20260131" alt="Zelle QR" class="zelle-qr-checkout">
                        <p style="margin-bottom: 0.5rem; font-size:1.2rem; color:var(--gold); font-weight:700;">Escanea el c√≥digo QR para pagar con Zelle</p>
                        <p style="margin-bottom: 0.5rem; font-size:1.2rem; color:var(--gold); font-weight:700;">Scan the QR code to pay with Zelle</p>
                        <p style="margin-bottom: 0.5rem; font-size:1.1rem;"><strong>Total:</strong> <span style="color: var(--gold); font-size: 1.3rem; font-weight:700;">${formatMoney(total)}</span></p>
                        <p style="color: #ff9800; margin-top: 1.2rem; font-size:1.05rem; font-weight:600;">‚ö†Ô∏è Una vez realices el pago con Zelle, haz clic en "Pagar Ahora" para ser redireccionado y enviar el comprobante de pago por WhatsApp.</p>
                        <p style="color: #ff9800; margin-top: 0.5rem; font-size:1.05rem; font-weight:600;">‚ö†Ô∏è After paying with Zelle, click "Pay Now" to be redirected and send your payment receipt via WhatsApp.</p>
                    </div>
                `;
            } else if (selectedPaymentMethod === 'BANCOLOMBIA') {
                instructions = `
                    <h4 style="color: var(--gold); margin-bottom: 1rem;">üè¶ Transferencia Bancolombia</h4>
                    <div style="color: #fff; line-height: 1.8;">
                        <p style="margin-bottom: 0.5rem;"><strong>Banco:</strong> Bancolombia</p>
                        <p style="margin-bottom: 0.5rem;"><strong>Tipo de cuenta:</strong> Ahorros</p>
                        <p style="margin-bottom: 0.5rem;"><strong>N√∫mero de cuenta:</strong> <span style="color: var(--gold); font-size: 1.2rem;">12345678901</span></p>
                        <p style="color: #ff9800; margin-top: 1rem;">‚ö†Ô∏è Despu√©s del pago, haz clic en "Pagar Ahora" para enviar el comprobante al WhatsApp +57 301 760 6723</p>
                    </div>
                `;
            } else if (selectedPaymentMethod === 'MERCADOPAGO') {
                const subtotal = cart.reduce((sum, item) => {
                    const prices = item.type === 'pack'
                        ? getPricePerUnit(1, 'pack')
                        : getPricePerUnit(item.quantity, 'product');
                    return sum + (prices[currentCurrency] * item.quantity);
                }, 0);
                const commission = subtotal * 0.05;
                const formatMoney = (amount) => {
                    if (currentCurrency === 'USD') {
                        return `$${amount.toFixed(2)} USD`;
                    }
                    return `$${Math.round(amount).toLocaleString('es-CO')} COP`;
                };
                instructions = `
                    <h4 style="color: var(--gold); margin-bottom: 1rem;">üí≥ Pago con Mercado Pago</h4>
                    <div style="color: #fff; line-height: 1.8;">
                        <p style="margin-bottom: 0.5rem;">Acepta tarjetas de cr√©dito, d√©bito, PSE, y m√°s.</p>
                        <div style="background: rgba(255, 152, 0, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem; border: 1px solid rgba(255, 152, 0, 0.3);">
                            <p style="color: #ff9800; margin: 0;"><strong>‚ö†Ô∏è Comisi√≥n del 5%:</strong> ${formatMoney(commission)}</p>
                            <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">El total a pagar ser√° ${formatMoney(subtotal + commission + shippingCost)}</p>
                        </div>
                    </div>
                `;
            } else if (selectedPaymentMethod === 'MERCADOLIBRE') {
                instructions = `
                    <h4 style="color: var(--gold); margin-bottom: 1rem;">üõí MercadoLibre Colombia</h4>
                    <div style="color: #fff; line-height: 1.8;">
                        <p style="margin-bottom: 1rem;">Ser√°s redirigido a MercadoLibre para completar tu compra de forma 100% segura.</p>
                        <div style="background: rgba(0, 184, 148, 0.1); padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 1px solid rgba(0, 184, 148, 0.3);">
                            <p style="color: #00b894; margin: 0; margin-bottom: 0.5rem;"><strong>‚úì Beneficios de comprar en MercadoLibre:</strong></p>
                            <p style="color: #00b894; margin: 0.3rem 0;">‚Ä¢ Protecci√≥n al comprador</p>
                            <p style="color: #00b894; margin: 0.3rem 0;">‚Ä¢ Todos los m√©todos de pago disponibles</p>
                            <p style="color: #00b894; margin: 0.3rem 0;">‚Ä¢ Seguimiento de env√≠o</p>
                            <p style="color: #00b894; margin: 0.3rem 0;">‚Ä¢ Garant√≠a de entrega</p>
                        </div>
                        <p style="color: var(--gold); margin-top: 1rem;"><strong>üëâ Haz clic en "Pagar Ahora" para ir a MercadoLibre</strong></p>
                        <p style="color: rgba(255, 255, 255, 0.7); margin-top: 0.5rem; font-size: 0.9rem;">No es necesario completar la informaci√≥n de env√≠o aqu√≠. Lo har√°s en MercadoLibre.</p>
                    </div>
                `;
            }

            instructionsDiv.innerHTML = instructions;
            updateOrderSummaryWithCommission();
        }

        function updateOrderSummaryWithCommission() {
            const subtotal = cart.reduce((sum, item) => {
                let prices;
                if (item.type === 'pack') {
                    const packType = item.packType || (item.products && item.products.length === 2 ? 'duo' : item.products && item.products.length === 3 ? 'trio' : item.products && item.products.length === 5 ? 'elella' : null);
                    prices = getPricePerUnit(1, 'pack', packType);
                } else {
                    prices = getPricePerUnit(item.quantity, 'product');
                }
                return sum + (prices[currentCurrency] * item.quantity);
            }, 0);

            const commission = selectedPaymentMethod === 'MERCADOPAGO' ? subtotal * 0.05 : 0;
            const total = subtotal + shippingCost + commission;

            const formatMoney = (amount) => {
                if (currentCurrency === 'USD') {
                    return `$${amount.toFixed(2)} USD`;
                } else {
                    return `$${Math.round(amount).toLocaleString('es-CO')} COP`;
                }
            };

            document.getElementById('subtotal').textContent = formatMoney(subtotal);
            document.getElementById('shipping').textContent = shippingCost > 0 ? formatMoney(shippingCost) : (currentCurrency === 'USD' ? 'Select method' : 'Seleccione m√©todo');
            
            // Actualizar total con comisi√≥n
            const totalsDiv = document.querySelector('.order-totals');
            let commissionRow = document.getElementById('commissionRow');
            
            if (commission > 0) {
                if (!commissionRow) {
                    commissionRow = document.createElement('div');
                    commissionRow.id = 'commissionRow';
                    commissionRow.className = 'order-total-row';
                    commissionRow.innerHTML = `
                        <span style="color: #ff9800;">Comisi√≥n Mercado Pago (5%)</span>
                        <span id="commissionAmount"></span>
                    `;
                    // Insertar antes del total final
                    const finalRow = totalsDiv.querySelector('.order-total-row.final');
                    totalsDiv.insertBefore(commissionRow, finalRow);
                }
                document.getElementById('commissionAmount').textContent = formatMoney(commission);
            } else {
                if (commissionRow) {
                    commissionRow.remove();
                }
            }
            
            document.getElementById('total').textContent = formatMoney(total);
        }

        function processPayment() {
            // Si es MercadoLibre, redirigir directamente sin validar formulario
            if (selectedPaymentMethod === 'MERCADOLIBRE') {
                if (cart.length === 0) {
                    alert('Tu carrito est√° vac√≠o');
                    return;
                }
                
                const cartSummary = cart.map(item => {
                    const quantity = item.quantity;
                    const name = item.type === 'pack' ? item.name : item.name;
                    return `${name} x${quantity}`;
                }).join(', ');
                
                const message = `¬øDeseas ir a MercadoLibre para completar tu compra?\n\nProductos en tu carrito:\n${cartSummary}\n\nEn MercadoLibre podr√°s:\n‚úì Ingresar tu direcci√≥n de env√≠o\n‚úì Elegir m√©todo de pago\n‚úì Completar tu compra de forma segura`;
                
                if (confirm(message)) {
                    redirectToMercadoLibre();
                }
                return;
            }
            
            const form = document.getElementById('checkoutForm');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // Validar que se haya seleccionado un m√©todo de env√≠o
            if (!selectedShippingMethod) {
                alert('Por favor selecciona un m√©todo de env√≠o');
                return;
            }

            const country = document.getElementById('country').value;
            // Solo requerir pa√≠s si no es pickup
            if (!country && selectedShippingMethod !== 'pickup') {
                alert('Por favor selecciona un pa√≠s');
                return;
            }

            const formData = {
                fullName: document.getElementById('fullName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value,
                postalCode: document.getElementById('postalCode').value,
                country: country,
                shippingMethod: selectedShippingMethod,
                paymentMethod: selectedPaymentMethod,
                cart: cart
            };

            // Calcular total con env√≠o
            const subtotal = cart.reduce((sum, item) => {
                const prices = item.type === 'pack' 
                    ? getPricePerUnit(1, 'pack') 
                    : getPricePerUnit(item.quantity, 'product');
                return sum + (prices[currentCurrency] * item.quantity);
            }, 0);
            
            const commission = selectedPaymentMethod === 'MERCADOPAGO' ? subtotal * 0.05 : 0;
            const total = subtotal + shippingCost + commission;

            // Si es Nequi, Zelle o Bancolombia, enviar informaci√≥n completa por WhatsApp
            if (selectedPaymentMethod === 'NEQUI' || selectedPaymentMethod === 'ZELLE' || selectedPaymentMethod === 'BANCOLOMBIA') {
                const methodName = selectedPaymentMethod === 'NEQUI' ? 'Nequi' : selectedPaymentMethod === 'ZELLE' ? 'Zelle' : 'Bancolombia';
                const formatMoney = (amount) => {
                    if (currentCurrency === 'USD') {
                        return `$${amount.toFixed(2)} USD`;
                    } else {
                        return `$${Math.round(amount).toLocaleString('es-CO')} COP`;
                    }
                };
                
                // Crear mensaje detallado con toda la informaci√≥n del pedido
                let itemsText = cart.map((item, index) => {
                    const prices = item.type === 'pack' 
                        ? getPricePerUnit(1, 'pack') 
                        : getPricePerUnit(item.quantity, 'product');
                    const itemTotal = prices[currentCurrency] * item.quantity;
                    
                    if (item.type === 'pack') {
                        const productsText = item.products.map(p => p.name).join(', ');
                        return `${index + 1}. *${item.quantity}x ${item.name}*\n    Fragancias: ${productsText}\n   üí∞ Subtotal: ${formatMoney(itemTotal)}`;
                    } else {
                        const fragranceName = item.name;
                        return `${index + 1}. *${item.quantity}x ${fragranceName}*\n   üí∞ Subtotal: ${formatMoney(itemTotal)}`;
                    }
                }).join('\n\n');
                
                let shippingInfo = '';
                if (selectedShippingMethod === 'pickup') {
                    const storeName = pickupStore === 'CO' ? 'Tienda Colombia üá®üá¥' : 'Tienda USA üá∫üá∏';
                    shippingInfo = `*M√âTODO DE ENTREGA:*\nüè¢ Recoger en ${storeName}\n\n`;
                } else {
                    shippingInfo = `*DIRECCI√ìN DE ENV√çO:*\n` +
                        `${formData.address}\n` +
                        `${formData.city}, ${formData.state}\n` +
                        `CP: ${formData.postalCode}\n` +
                        `Pa√≠s: ${formData.country}\n\n`;
                }
                
                let paymentInfo = '';
                if (selectedPaymentMethod === 'NEQUI') {
                    paymentInfo = `*N√∫mero Nequi:* +57 301 760 6723\n*A nombre de:* Alejandra Vela Moreno`;
                } else if (selectedPaymentMethod === 'ZELLE') {
                    paymentInfo = `*Email Zelle:* fresche@fresche1.com\n*QR disponible en el checkout*`;
                } else if (selectedPaymentMethod === 'BANCOLOMBIA') {
                    paymentInfo = `*Banco:* Bancolombia\n*Cuenta de Ahorros:* 12345678901`;
                }
                
                const whatsappMsg = `üõçÔ∏è *NUEVO PEDIDO - ${methodName}*\n\n` +
                    `*DATOS DEL CLIENTE:*\n` +
                    `üë§ Nombre: ${formData.fullName}\n` +
                    `üìß Email: ${formData.email}\n` +
                    `üì± Tel√©fono: ${formData.phone}\n\n` +
                    shippingInfo +
                    `*PRODUCTOS:*\n${itemsText}\n\n` +
                    `*RESUMEN:*\n` +
                    `Subtotal: ${formatMoney(subtotal)}\n` +
                    `Env√≠o: ${formatMoney(shippingCost)}\n` +
                    `*TOTAL A PAGAR: ${formatMoney(total)}*\n\n` +
                    `üí≥ *M√âTODO DE PAGO: ${methodName}*\n` +
                    `${paymentInfo}\n\n` +
                    `‚ö†Ô∏è *POR FAVOR ADJUNTA TU COMPROBANTE DE PAGO*`;
                
                // Redirigir directo a WhatsApp con toda la informaci√≥n
                window.location.href = `https://wa.me/573017606723?text=${encodeURIComponent(whatsappMsg)}`;
                
                return;
            }

            // Si es Mercado Pago, continuar con el flujo normal
            if (selectedPaymentMethod === 'MERCADOPAGO') {
                createMercadoPagoCheckout(formData, total, subtotal + commission);
            }
        }

        function redirectToMercadoLibre() {
            // URL del producto en MercadoLibre Colombia
            const mercadoLibreURL = 'https://articulo.mercadolibre.com.co/MCO-1801564823-crema-intima-fresche-30-ml-hidratante-hipoalergenica-_JM';
            
            // Guardar carrito por si el usuario regresa
            localStorage.setItem('pendingMLOrder', JSON.stringify({
                cart: cart,
                timestamp: Date.now()
            }));
            
            // Abrir MercadoLibre en la misma pesta√±a
            window.location.href = mercadoLibreURL;
        }

        async function createMercadoPagoCheckout(formData, total, subtotal) {
            try {
                // Mostrar mensaje de carga
                const loadingMsg = document.createElement('div');
                loadingMsg.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); color: var(--gold); padding: 2rem 3rem; border-radius: 10px; z-index: 10000; text-align: center; font-size: 1.2rem;';
                loadingMsg.innerHTML = '<div style="margin-bottom: 1rem;">‚è≥</div>Procesando pago...<br><small style="font-size: 0.8rem; opacity: 0.8;">Redirigiendo a MercadoPago</small>';
                document.body.appendChild(loadingMsg);
                
                // Calcular comisi√≥n del 5%
                const commission = cart.reduce((sum, item) => {
                    const prices = item.type === 'pack' 
                        ? getPricePerUnit(1, 'pack') 
                        : getPricePerUnit(item.quantity, 'product');
                    return sum + (prices[currentCurrency] * item.quantity);
                }, 0) * 0.05;
                
                // Preparar items para Mercado Pago
                const items = cart.map(item => {
                    const prices = item.type === 'pack' 
                        ? getPricePerUnit(1, 'pack') 
                        : getPricePerUnit(item.quantity, 'product');
                    const unitPrice = prices[currentCurrency];
                    
                    return {
                        title: item.type === 'pack' 
                            ? `${item.name} (${item.products.map(p => p.id).join(', ')})` 
                            : item.name,
                        quantity: item.quantity,
                        unit_price: unitPrice,
                        currency_id: currentCurrency
                    };
                });

                // Agregar comisi√≥n como item
                if (commission > 0) {
                    items.push({
                        title: 'Comisi√≥n Mercado Pago (5%)',
                        quantity: 1,
                        unit_price: commission,
                        currency_id: currentCurrency
                    });
                }

                // Agregar env√≠o como item
                items.push({
                    title: 'Env√≠o',
                    quantity: 1,
                    unit_price: shippingCost,
                    currency_id: currentCurrency
                });

                // Crear preferencia
                const preference = {
                    items: items,
                    payer: {
                        name: formData.fullName,
                        email: formData.email,
                        phone: {
                            area_code: '',
                            number: formData.phone
                        },
                        address: {
                            street_name: formData.address,
                            street_number: '',
                            zip_code: formData.postalCode
                        }
                    },
                    back_urls: {
                        success: window.location.origin + '/payment-response.html?status=success',
                        failure: window.location.origin + '/payment-response.html?status=failure',
                        pending: window.location.origin + '/payment-response.html?status=pending'
                    },
                    auto_return: 'approved',
                    external_reference: 'FRESCHE-' + Date.now(),
                    notification_url: window.location.origin + '/mercadopago-webhook',
                    statement_descriptor: 'FRESCHE'
                };

                // Llamar a tu backend para crear la preferencia de pago
                const response = await fetch(`${BACKEND_URL}/api/create-preference`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        preference,
                        orderData: {
                            customerName: formData.fullName,
                            email: formData.email,
                            phone: formData.phone,
                            address: formData.address,
                            city: formData.city,
                            state: formData.state,
                            zipCode: formData.postalCode,
                            shippingMethod: formData.shippingMethod,
                            subtotal: subtotal,
                            shippingCost: shippingCost,
                            total: total,
                            currency: currentCurrency,
                            items: cart.map(item => ({
                                name: item.name,
                                quantity: item.quantity,
                                type: item.type,
                                products: item.products
                            }))
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error('No se pudo crear la preferencia');
                }

                const data = await response.json();

                // Guardar datos del pedido localmente
                localStorage.setItem('orderData', JSON.stringify({
                    formData,
                    cart,
                    total,
                    subtotal,
                    shipping: shippingCost,
                    currency: currentCurrency,
                    date: new Date().toISOString()
                }));

                // Redirigir al checkout de Mercado Pago
                window.location.href = data.init_point;
                
            } catch (error) {
                console.error('Error al crear preferencia de Mercado Pago:', error);
                // Remover mensaje de carga si existe
                const loadingMsg = document.querySelector('[style*="Procesando pago"]');
                if (loadingMsg) loadingMsg.remove();
                alert('Error al procesar el pago. Por favor int√©ntalo nuevamente.');
            }
        }

        // Cargar carrito al inicio
        window.addEventListener('DOMContentLoaded', () => {
            loadCart();
            const pickupSelected = localStorage.getItem('fresche_pickup') === 'true';
            if (pickupSelected) {
                selectedShippingMethod = 'pickup';
                shippingCost = 0;
                pickupStore = null;
                updateShippingCost();
                renderPickupStoreSelector();
                selectShippingMethod('pickup', 0);
            }
            // Inicializar instrucciones de pago
            const defaultPaymentMethod = document.querySelector('.payment-method.selected');
            if (defaultPaymentMethod) {
                selectPaymentMethod(defaultPaymentMethod);
            }
            
            // Agregar listener para actualizar env√≠o cuando cambie la ciudad
            const cityInput = document.getElementById('city');
            if (cityInput) {
                cityInput.addEventListener('blur', updateShippingCost);
                cityInput.addEventListener('change', updateShippingCost);
            }
            
            // Agregar listeners a campos de direcci√≥n para actualizar resumen
            const addressInput = document.getElementById('address');
            const stateInput = document.getElementById('state');
            
            if (addressInput) {
                addressInput.addEventListener('blur', displayOrderSummary);
                addressInput.addEventListener('change', displayOrderSummary);
            }
            
            if (stateInput) {
                stateInput.addEventListener('blur', displayOrderSummary);
                stateInput.addEventListener('change', displayOrderSummary);
            }
            updateCustomerInfoVisibility();
        });
    </script>
</body>
</html>
