<!DOCTYPE html>
<html lang="es" data-lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - FRESCHE</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <style>
        .checkout-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
        }

        .checkout-section {
            background: rgba(30, 30, 30, 0.95);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 15px;
            padding: 2rem;
        }

        .checkout-section h2 {
            color: var(--gold);
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            color: var(--gold);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            color: #fff;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .order-summary {
            position: sticky;
            top: 2rem;
            height: fit-content;
        }

        .order-item {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(212, 175, 55, 0.2);
        }

        .order-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
        }

        .order-item-info {
            flex: 1;
        }

        .order-item-name {
            color: #fff;
            font-weight: 600;
            margin-bottom: 0.3rem;
        }

        .order-item-quantity {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        .order-item-price {
            color: var(--gold);
            font-weight: bold;
        }

        .order-totals {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid rgba(212, 175, 55, 0.3);
        }

        .order-total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.8rem;
            color: #fff;
        }

        .order-total-row.final {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--gold);
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid var(--gold);
        }

        .btn-pay {
            width: 100%;
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--gold), #ffd700);
            color: #000;
            border: none;
            border-radius: 10px;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 1.5rem;
        }

        .btn-pay:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(212, 175, 55, 0.5);
        }

        .btn-pay:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .payment-methods {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .payment-method {
            padding: 1.2rem;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .payment-method:hover {
            border-color: var(--gold);
            background: rgba(212, 175, 55, 0.1);
        }

        .payment-method.selected {
            border-color: var(--gold);
            background: rgba(212, 175, 55, 0.2);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
        }

        .payment-method-icon {
            font-size: 2.5rem;
        }

        .payment-method-info {
            flex: 1;
        }

        .payment-method-name {
            color: #fff;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.3rem;
        }

        .payment-method-desc {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        .test-mode-banner {
            background: linear-gradient(90deg, #ff9800, #ff5722);
            color: #fff;
            padding: 1rem;
            text-align: center;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .shipping-options {
            display: grid;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .shipping-option {
            padding: 1.2rem;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .shipping-option:hover {
            border-color: var(--gold);
            background: rgba(212, 175, 55, 0.1);
        }

        .shipping-option.selected {
            border-color: var(--gold);
            background: rgba(212, 175, 55, 0.2);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
        }

        .shipping-option-info {
            flex: 1;
        }

        .shipping-option-name {
            color: #fff;
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.3rem;
        }

        .shipping-option-desc {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        .shipping-option-price {
            color: var(--gold);
            font-weight: bold;
            font-size: 1.3rem;
        }

        .shipping-alert {
            background: rgba(255, 152, 0, 0.1);
            border: 1px solid rgba(255, 152, 0, 0.3);
            padding: 1rem;
            border-radius: 8px;
            color: #ff9800;
            margin-bottom: 1rem;
        }

        @media (max-width: 968px) {
            .checkout-container {
                grid-template-columns: 1fr;
            }

            .order-summary {
                position: relative;
                top: 0;
            }
        }
    </style>
</head>
<body>
    <div class="checkout-container">
        <!-- Formulario de Checkout -->
        <div class="checkout-section">
            <h2 data-es="Informaci√≥n de Pago" data-en="Payment Information">Informaci√≥n de Pago</h2>
            
            <form id="checkoutForm">
                <!-- Datos Personales -->
                <div class="form-group">
                    <label data-es="Nombre Completo *" data-en="Full Name *">Nombre Completo *</label>
                    <input type="text" id="fullName" required placeholder="Juan P√©rez">
                </div>

                <div class="form-group">
                    <label data-es="Email *" data-en="Email *">Email *</label>
                    <input type="email" id="email" required placeholder="tu@email.com">
                </div>

                <div class="form-group">
                    <label data-es="Tel√©fono *" data-en="Phone *">Tel√©fono *</label>
                    <input type="tel" id="phone" required placeholder="+57 300 123 4567">
                </div>

                <!-- Direcci√≥n de Env√≠o -->
                <h3 style="color: var(--gold); margin: 2rem 0 1rem;">
                    <span data-es="Direcci√≥n de Env√≠o" data-en="Shipping Address">Direcci√≥n de Env√≠o</span>
                </h3>

                <div class="form-group">
                    <label data-es="Direcci√≥n *" data-en="Address *">Direcci√≥n *</label>
                    <input type="text" id="address" required placeholder="Calle 123 #45-67">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label data-es="Ciudad *" data-en="City *">Ciudad *</label>
                        <input type="text" id="city" required placeholder="Bogot√°">
                    </div>
                    <div class="form-group">
                        <label data-es="C√≥digo Postal" data-en="Postal Code">C√≥digo Postal</label>
                        <input type="text" id="postalCode" placeholder="110111">
                    </div>
                </div>

                <div class="form-group">
                    <label data-es="Pa√≠s *" data-en="Country *">Pa√≠s *</label>
                    <select id="country" required onchange="updateShippingCost()">
                        <option value="">Selecciona un pa√≠s</option>
                        <option value="CO">üá®üá¥ Colombia</option>
                        <option value="US">üá∫üá∏ Estados Unidos</option>
                        <option value="CA">üá®üá¶ Canad√°</option>
                        <option value="MX">üá≤üáΩ M√©xico</option>
                        <option value="ES">üá™üá∏ Espa√±a</option>
                        <option value="AR">üá¶üá∑ Argentina</option>
                        <option value="CL">üá®üá± Chile</option>
                        <option value="PE">üáµüá™ Per√∫</option>
                        <option value="EC">üá™üá® Ecuador</option>
                        <option value="BR">üáßüá∑ Brasil</option>
                        <option value="OTHER">üåé Otro pa√≠s</option>
                    </select>
                </div>

                <div class="form-group">
                    <label data-es="Departamento/Estado *" data-en="State *">Departamento/Estado *</label>
                    <input type="text" id="state" required placeholder="Cundinamarca">
                </div>

                <!-- Opciones de Env√≠o -->
                <h3 style="color: var(--gold); margin: 2rem 0 1rem;">
                    <span data-es="M√©todo de Env√≠o" data-en="Shipping Method">M√©todo de Env√≠o</span>
                </h3>

                <div id="shippingOptions" class="shipping-options">
                    <!-- Se llenar√°n din√°micamente seg√∫n el pa√≠s -->
                </div>

                <!-- M√©todo de Pago -->
                <h3 style="color: var(--gold); margin: 2rem 0 1rem;">
                    <span data-es="M√©todo de Pago" data-en="Payment Method">M√©todo de Pago</span>
                </h3>

                <div class="payment-methods" id="paymentMethodsContainer">
                    <div class="payment-method selected" data-method="NEQUI" data-region="CO" onclick="selectPaymentMethod(this)">
                        <div class="payment-method-icon">üì±</div>
                        <div class="payment-method-info">
                            <div class="payment-method-name">Nequi</div>
                            <div class="payment-method-desc">Pago directo sin comisi√≥n</div>
                        </div>
                    </div>
                    <div class="payment-method" data-method="BANK" data-region="CO" onclick="selectPaymentMethod(this)">
                        <div class="payment-method-icon">üè¶</div>
                        <div class="payment-method-info">
                            <div class="payment-method-name">Transferencia Bancaria</div>
                            <div class="payment-method-desc">Pago directo sin comisi√≥n</div>
                        </div>
                    </div>
                    <div class="payment-method" data-method="ZELLE" data-region="US" onclick="selectPaymentMethod(this)" style="display:none;">
                        <div class="payment-method-icon">üíµ</div>
                        <div class="payment-method-info">
                            <div class="payment-method-name">Zelle</div>
                            <div class="payment-method-desc">Direct payment - No fees</div>
                        </div>
                    </div>
                    <div class="payment-method" data-method="MERCADOPAGO" data-region="ALL" onclick="selectPaymentMethod(this)">
                        <div class="payment-method-icon">üí≥</div>
                        <div class="payment-method-info">
                            <div class="payment-method-name">Mercado Pago</div>
                            <div class="payment-method-desc" style="color: #ff9800;">+ 5% comisi√≥n</div>
                        </div>
                    </div>
                </div>

                <div id="paymentInstructions" style="margin-top: 1.5rem; padding: 1.5rem; background: rgba(212, 175, 55, 0.1); border: 2px solid rgba(212, 175, 55, 0.3); border-radius: 10px;">
                    <!-- Instrucciones de pago din√°micas -->
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="terms" required style="width: auto; margin-right: 0.5rem;">
                        <span data-es="Acepto t√©rminos y condiciones" data-en="I accept terms and conditions">
                            Acepto t√©rminos y condiciones
                        </span>
                    </label>
                </div>
            </form>
        </div>

        <!-- Resumen del Pedido -->
        <div class="order-summary checkout-section">
            <h2 data-es="Resumen del Pedido" data-en="Order Summary">Resumen del Pedido</h2>
            
            <div id="orderItems"></div>

            <div class="order-totals">
                <div class="order-total-row">
                    <span data-es="Subtotal" data-en="Subtotal">Subtotal</span>
                    <span id="subtotal">$0</span>
                </div>
                <div class="order-total-row">
                    <span data-es="Env√≠o" data-en="Shipping">Env√≠o</span>
                    <span id="shipping">$10.000 COP</span>
                </div>
                <div class="order-total-row final">
                    <span data-es="Total" data-en="Total">Total</span>
                    <span id="total">$0</span>
                </div>
            </div>

            <button class="btn-pay" onclick="processPayment()">
                <span data-es="üîí Pagar Ahora" data-en="üîí Pay Now">üîí Pagar Ahora</span>
            </button>

            <div style="margin-top: 1rem; padding: 1rem; background: rgba(212, 175, 55, 0.1); border-radius: 8px; font-size: 0.9rem; color: rgba(255, 255, 255, 0.8); border: 1px solid rgba(212, 175, 55, 0.3);">
                <strong style="color: var(--gold);">üîí Pago Seguro</strong><br>
                Transacci√≥n procesada por Mercado Pago, plataforma l√≠der de pagos en Am√©rica Latina.
            </div>
        </div>
    </div>

    <script>
        let cart = [];
        let selectedPaymentMethod = 'NEQUI';
        let selectedShippingMethod = null;
        let shippingCost = 0;
        let currentCurrency = 'COP'; // Moneda por defecto
        const BACKEND_URL = 'https://fresche1-com.onrender.com';

        // Tarifas de env√≠o reales
        const shippingRates = {
            CO: [
                { id: 'standard', name: 'Servientrega Est√°ndar', desc: '5-7 d√≠as h√°biles', price: 15000, currency: 'COP' },
                { id: 'express', name: 'Servientrega Express', desc: '2-3 d√≠as h√°biles', price: 25000, currency: 'COP' },
                { id: 'priority', name: 'Servientrega Prioritario', desc: '1 d√≠a h√°bil', price: 35000, currency: 'COP' }
            ],
            US: [
                { id: 'standard', name: 'FedEx International Economy', desc: '10-15 business days', price: 12, currency: 'USD' },
                { id: 'express', name: 'FedEx International Priority', desc: '5-7 business days', price: 22, currency: 'USD' },
                { id: 'priority', name: 'FedEx International First', desc: '3-5 business days', price: 35, currency: 'USD' }
            ],
            CA: [
                { id: 'standard', name: 'FedEx International Economy', desc: '10-15 business days', price: 13, currency: 'USD' },
                { id: 'express', name: 'FedEx International Priority', desc: '5-7 business days', price: 24, currency: 'USD' }
            ],
            MX: [
                { id: 'standard', name: 'FedEx International Economy', desc: '8-12 d√≠as h√°biles', price: 35000, currency: 'COP' },
                { id: 'express', name: 'FedEx International Priority', desc: '4-6 d√≠as h√°biles', price: 65000, currency: 'COP' }
            ],
            ES: [
                { id: 'standard', name: 'FedEx International Economy', desc: '12-18 d√≠as h√°biles', price: 15, currency: 'USD' },
                { id: 'express', name: 'FedEx International Priority', desc: '6-8 d√≠as h√°biles', price: 26, currency: 'USD' }
            ],
            AR: [
                { id: 'standard', name: 'FedEx International Economy', desc: '10-15 d√≠as h√°biles', price: 40000, currency: 'COP' },
                { id: 'express', name: 'FedEx International Priority', desc: '5-7 d√≠as h√°biles', price: 75000, currency: 'COP' }
            ],
            CL: [
                { id: 'standard', name: 'FedEx International Economy', desc: '10-15 d√≠as h√°biles', price: 40000, currency: 'COP' },
                { id: 'express', name: 'FedEx International Priority', desc: '5-7 d√≠as h√°biles', price: 75000, currency: 'COP' }
            ],
            PE: [
                { id: 'standard', name: 'FedEx International Economy', desc: '8-12 d√≠as h√°biles', price: 35000, currency: 'COP' },
                { id: 'express', name: 'FedEx International Priority', desc: '4-6 d√≠as h√°biles', price: 65000, currency: 'COP' }
            ],
            EC: [
                { id: 'standard', name: 'FedEx International Economy', desc: '8-12 d√≠as h√°biles', price: 35000, currency: 'COP' },
                { id: 'express', name: 'FedEx International Priority', desc: '4-6 d√≠as h√°biles', price: 65000, currency: 'COP' }
            ],
            BR: [
                { id: 'standard', name: 'FedEx International Economy', desc: '12-18 d√≠as h√°biles', price: 55000, currency: 'COP' },
                { id: 'express', name: 'FedEx International Priority', desc: '6-8 d√≠as h√°biles', price: 95000, currency: 'COP' }
            ],
            OTHER: [
                { id: 'standard', name: 'FedEx International Economy', desc: '15-25 business days', price: 18, currency: 'USD' },
                { id: 'express', name: 'FedEx International Priority', desc: '7-10 business days', price: 30, currency: 'USD' }
            ]
        };

        // Tabla de precios din√°micos por cantidad (en d√≥lares)
        const priceTable = {
            1: { USD: 18.50, COP: 29900 },
            2: { USD: 34.99, COP: 139960 },
            3: { USD: 44.99, COP: 179960 },
            'pack_elella': { USD: 69.99, COP: 279960 }  // Pack El y Ella (5 unidades)
        };

        // Funci√≥n para obtener precio seg√∫n cantidad y tipo de producto
        function getPricePerUnit(quantity, itemType) {
            // Si es pack "El y Ella"
            if (itemType === 'pack' && quantity === 1) {
                return priceTable['pack_elella'];
            }
            
            // Para productos normales, retornar tabla seg√∫n cantidad
            if (priceTable[quantity]) {
                return priceTable[quantity];
            }
            
            // Si la cantidad no est√° en tabla, usar precio base
            return priceTable[1];
        }

        // Pa√≠ses que usan USD
        const usdCountries = ['US', 'CA', 'ES', 'OTHER'];
        


        // Cargar carrito
        function loadCart() {
            const savedCart = localStorage.getItem('freshCart');
            if (savedCart) {
                cart = JSON.parse(savedCart);
            }

            if (cart.length === 0) {
                window.location.href = 'index.html';
                return;
            }

            // Detectar idioma actual
            const language = document.documentElement.lang || 'es';
            
            // Establecer pa√≠s por defecto Colombia
            document.getElementById('country').value = 'CO';
            
            // Si est√° en ingl√©s, cambiar a USD autom√°ticamente
            if (language === 'en') {
                currentCurrency = 'USD';
            } else {
                currentCurrency = 'COP';
            }

            // Mostrar de inmediato las opciones de env√≠o seg√∫n el pa√≠s por defecto
            updateShippingCost();
            displayOrderSummary();
        }

        function displayOrderSummary() {
            const orderItemsDiv = document.getElementById('orderItems');
            const language = document.documentElement.lang || 'es';
            
            // Detectar si est√° en ingl√©s o si detectamos ubicaci√≥n internacional
            let useUSD = (currentCurrency === 'USD');
            const isEnglish = language === 'en';
            
            // Si est√° en ingl√©s, cambiar a USD autom√°ticamente
            if (isEnglish && currentCurrency === 'COP') {
                currentCurrency = 'USD';
                useUSD = true;
            }
            
            let subtotal = 0;

            orderItemsDiv.innerHTML = cart.map(item => {
                let itemTotal;
                let itemName;
                let itemImage;
                let itemQuantity = item.quantity;
                let prices;

                if (item.type === 'pack') {
                    // Para packs, usar el precio del pack
                    prices = getPricePerUnit(1, 'pack');
                    itemTotal = prices[currentCurrency] * item.quantity;
                    itemName = `${item.name} (${item.products.map(p => p.id).join(', ')})`;
                    itemImage = 'images/cherry.jpg';
                } else {
                    // Para productos normales
                    prices = getPricePerUnit(itemQuantity, 'product');
                    itemTotal = prices[currentCurrency] * item.quantity;
                    itemName = item.name;
                    itemImage = item.image;
                }

                subtotal += itemTotal;

                const formattedPrice = (currentCurrency === 'USD') 
                    ? `$${itemTotal.toFixed(2)}` 
                    : `$${Math.round(itemTotal).toLocaleString('es-CO')}`;

                return `
                    <div class="order-item">
                        <img src="${itemImage}" alt="${itemName}">
                        <div class="order-item-info">
                            <div class="order-item-name">${itemName}</div>
                            <div class="order-item-quantity">Cantidad: ${itemQuantity}</div>
                        </div>
                        <div class="order-item-price">${formattedPrice}</div>
                    </div>
                `;
            }).join('');

            const total = subtotal + shippingCost;

            const formatMoney = (amount) => {
                if (currentCurrency === 'USD') {
                    return `$${amount.toFixed(2)} USD`;
                } else {
                    return `$${Math.round(amount).toLocaleString('es-CO')} COP`;
                }
            };

            document.getElementById('subtotal').textContent = formatMoney(subtotal);
            document.getElementById('shipping').textContent = shippingCost > 0 ? formatMoney(shippingCost) : (isEnglish ? 'Select method' : 'Seleccione m√©todo');
            document.getElementById('total').textContent = formatMoney(total);
        }

        function updateShippingCost() {
            const country = document.getElementById('country').value;
            const shippingOptionsDiv = document.getElementById('shippingOptions');
            const language = document.documentElement.lang || 'es';
            const isEnglish = language === 'en';

            if (!country) {
                const alertMsg = isEnglish ? 'Select a country to see shipping options' : 'Selecciona un pa√≠s para ver las opciones de env√≠o';
                shippingOptionsDiv.innerHTML = `<div class="shipping-alert">‚ö†Ô∏è ${alertMsg}</div>`;
                shippingCost = 0;
                selectedShippingMethod = null;
                currentCurrency = (isEnglish || country !== 'CO') ? 'USD' : 'COP';
                displayOrderSummary();
                return;
            }

            // Si est√° en ingl√©s O si el pa√≠s no es Colombia, usar USD
            const useUSD = usdCountries.includes(country) || isEnglish || country !== 'CO';
            currentCurrency = useUSD ? 'USD' : 'COP';
            
            // Mostrar/ocultar m√©todos de pago seg√∫n el pa√≠s
            updatePaymentMethods(country);

            const options = shippingRates[country] || shippingRates.OTHER;
            
            shippingOptionsDiv.innerHTML = options.map(option => {
                const formattedPrice = currentCurrency === 'USD' 
                    ? `$${option.price.toFixed(2)} USD`
                    : `$${Math.round(option.price).toLocaleString('es-CO')} COP`;
                
                return `
                    <div class="shipping-option ${selectedShippingMethod === option.id ? 'selected' : ''}" 
                         onclick="selectShippingMethod('${option.id}', ${option.price})">
                        <div class="shipping-option-info">
                            <div class="shipping-option-name">${option.name}</div>
                            <div class="shipping-option-desc">üì¶ ${option.desc}</div>
                        </div>
                        <div class="shipping-option-price">${formattedPrice}</div>
                    </div>
                `;
            }).join('');

            // Resetear selecci√≥n de env√≠o al cambiar de pa√≠s
            selectedShippingMethod = null;
            shippingCost = 0;
            displayOrderSummary();
        }

        function updatePaymentMethods(country) {
            const nequiMethod = document.querySelector('[data-method="NEQUI"]');
            const bankMethod = document.querySelector('[data-method="BANK"]');
            const zelleMethod = document.querySelector('[data-method="ZELLE"]');
            
            // Colombia: Mostrar Nequi y Transferencia, ocultar Zelle
            if (country === 'CO') {
                if (nequiMethod) nequiMethod.style.display = 'flex';
                if (bankMethod) bankMethod.style.display = 'flex';
                if (zelleMethod) zelleMethod.style.display = 'none';
                
                // Si Zelle estaba seleccionado, cambiar a Nequi
                if (selectedPaymentMethod === 'ZELLE') {
                    if (nequiMethod) {
                        selectPaymentMethod(nequiMethod);
                    }
                }
            } 
            // USA/Canad√°: Mostrar Zelle, ocultar Nequi y Transferencia
            else if (country === 'US' || country === 'CA') {
                if (nequiMethod) nequiMethod.style.display = 'none';
                if (bankMethod) bankMethod.style.display = 'none';
                if (zelleMethod) zelleMethod.style.display = 'flex';
                
                // Si Nequi o Bank estaba seleccionado, cambiar a Zelle
                if (selectedPaymentMethod === 'NEQUI' || selectedPaymentMethod === 'BANK') {
                    if (zelleMethod) {
                        selectPaymentMethod(zelleMethod);
                    }
                }
            }
            // Otros pa√≠ses: Ocultar m√©todos locales, solo Mercado Pago
            else {
                if (nequiMethod) nequiMethod.style.display = 'none';
                if (bankMethod) bankMethod.style.display = 'none';
                if (zelleMethod) zelleMethod.style.display = 'none';
                
                // Cambiar a Mercado Pago si un m√©todo local estaba seleccionado
                if (selectedPaymentMethod !== 'MERCADOPAGO') {
                    const mercadopagoMethod = document.querySelector('[data-method="MERCADOPAGO"]');
                    if (mercadopagoMethod) {
                        selectPaymentMethod(mercadopagoMethod);
                    }
                }
            }
        }

        function selectShippingMethod(methodId, price) {
            selectedShippingMethod = methodId;
            shippingCost = price;
            
            // Actualizar visualmente
            document.querySelectorAll('.shipping-option').forEach(el => el.classList.remove('selected'));
            event.target.closest('.shipping-option').classList.add('selected');
            
            // Actualizar resumen
            displayOrderSummary();
        }

        function selectPaymentMethod(element) {
            document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedPaymentMethod = element.dataset.method;
            
            // Mostrar instrucciones seg√∫n el m√©todo
            const instructionsDiv = document.getElementById('paymentInstructions');
            let instructions = '';
            
            if (selectedPaymentMethod === 'NEQUI') {
                instructions = `
                    <h4 style="color: var(--gold); margin-bottom: 1rem;">üì± Pago por Nequi</h4>
                    <div style="color: #fff; line-height: 1.8;">
                        <p style="margin-bottom: 0.5rem;"><strong>N√∫mero Nequi:</strong> <span style="color: var(--gold); font-size: 1.2rem;">+57 301 760 6723</span></p>
                        <p style="margin-bottom: 0.5rem;"><strong>A nombre de:</strong> Alejandra Vela Moreno</p>
                        <p style="color: #ff9800; margin-top: 1rem;">‚ö†Ô∏è Despu√©s del pago, env√≠a el comprobante al WhatsApp +57 301 760 6723</p>
                    </div>
                `;
            } else if (selectedPaymentMethod === 'BANK') {
                instructions = `
                    <h4 style="color: var(--gold); margin-bottom: 1rem;">üè¶ Transferencia Bancaria</h4>
                    <div style="color: #fff; line-height: 1.8;">
                        <p style="margin-bottom: 0.5rem;"><strong>Banco:</strong> Bancolombia</p>
                        <p style="margin-bottom: 0.5rem;"><strong>Tipo de cuenta:</strong> Ahorros</p>
                        <p style="margin-bottom: 0.5rem;"><strong>N√∫mero:</strong> <span style="color: var(--gold); font-size: 1.2rem;">944-0003-0698</span></p>
                        <p style="margin-bottom: 0.5rem;"><strong>Titular:</strong> Alejandra Vela Moreno</p>
                        <p style="margin-bottom: 0.5rem;"><strong>C√©dula:</strong> 1.020.734.152</p>
                        <p style="color: #ff9800; margin-top: 1rem;">‚ö†Ô∏è Despu√©s del pago, env√≠a el comprobante al WhatsApp +57 301 760 6723</p>
                    </div>
                `;
            } else if (selectedPaymentMethod === 'ZELLE') {
                const formatMoney = (amount) => {
                    if (currentCurrency === 'USD') {
                        return `$${amount.toFixed(2)} USD`;
                    } else {
                        return `$${Math.round(amount).toLocaleString('es-CO')} COP`;
                    }
                };
                const subtotal = cart.reduce((sum, item) => {
                    const prices = item.type === 'pack' 
                        ? getPricePerUnit(1, 'pack') 
                        : getPricePerUnit(item.quantity, 'product');
                    return sum + (prices[currentCurrency] * item.quantity);
                }, 0);
                const total = subtotal + shippingCost;
                instructions = `
                    <h4 style="color: var(--gold); margin-bottom: 1rem;">üíµ Zelle Payment</h4>
                    <div style="color: #fff; line-height: 1.8;">
                        <p style="margin-bottom: 0.5rem;"><strong>Zelle Phone:</strong> <span style="color: var(--gold); font-size: 1.2rem;">+1 917 832 5649</span></p>
                        <p style="margin-bottom: 0.5rem;"><strong>Name:</strong> Alejandra Vela Moreno</p>
                        <p style="margin-bottom: 0.5rem;"><strong>Total to send:</strong> <span style="color: var(--gold); font-size: 1.2rem;">${formatMoney(total)}</span></p>
                        <p style="color: #ff9800; margin-top: 1rem;">‚ö†Ô∏è After payment, send proof to WhatsApp +57 301 760 6723</p>
                    </div>
                `;
            } else if (selectedPaymentMethod === 'MERCADOPAGO') {
                const subtotal = cart.reduce((sum, item) => {
                    const prices = item.type === 'pack' 
                        ? getPricePerUnit(1, 'pack') 
                        : getPricePerUnit(item.quantity, 'product');
                    return sum + (prices[currentCurrency] * item.quantity);
                }, 0);
                const commission = subtotal * 0.05;
                const formatMoney = (amount) => {
                    if (currentCurrency === 'USD') {
                        return `$${amount.toFixed(2)} USD`;
                    } else {
                        return `$${Math.round(amount).toLocaleString('es-CO')} COP`;
                    }
                };
                instructions = `
                    <h4 style="color: var(--gold); margin-bottom: 1rem;">üí≥ Pago con Mercado Pago</h4>
                    <div style="color: #fff; line-height: 1.8;">
                        <p style="margin-bottom: 0.5rem;">Acepta tarjetas de cr√©dito, d√©bito, PSE, y m√°s.</p>
                        <div style="background: rgba(255, 152, 0, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem; border: 1px solid rgba(255, 152, 0, 0.3);">
                            <p style="color: #ff9800; margin: 0;"><strong>‚ö†Ô∏è Comisi√≥n del 5%:</strong> ${formatMoney(commission)}</p>
                            <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">El total a pagar ser√° ${formatMoney(subtotal + commission + shippingCost)}</p>
                        </div>
                    </div>
                `;
            }
            
            instructionsDiv.innerHTML = instructions;
            
            // Actualizar el resumen del pedido con la comisi√≥n si es Mercado Pago
            updateOrderSummaryWithCommission();
        }

        function updateOrderSummaryWithCommission() {
            const subtotal = cart.reduce((sum, item) => {
                const prices = item.type === 'pack' 
                    ? getPricePerUnit(1, 'pack') 
                    : getPricePerUnit(item.quantity, 'product');
                return sum + (prices[currentCurrency] * item.quantity);
            }, 0);

            const commission = selectedPaymentMethod === 'MERCADOPAGO' ? subtotal * 0.05 : 0;
            const total = subtotal + shippingCost + commission;

            const formatMoney = (amount) => {
                if (currentCurrency === 'USD') {
                    return `$${amount.toFixed(2)} USD`;
                } else {
                    return `$${Math.round(amount).toLocaleString('es-CO')} COP`;
                }
            };

            document.getElementById('subtotal').textContent = formatMoney(subtotal);
            document.getElementById('shipping').textContent = shippingCost > 0 ? formatMoney(shippingCost) : 'Seleccione m√©todo';
            
            // Actualizar total con comisi√≥n
            const totalsDiv = document.querySelector('.order-totals');
            let commissionRow = document.getElementById('commissionRow');
            
            if (commission > 0) {
                if (!commissionRow) {
                    commissionRow = document.createElement('div');
                    commissionRow.id = 'commissionRow';
                    commissionRow.className = 'order-total-row';
                    commissionRow.innerHTML = `
                        <span style="color: #ff9800;">Comisi√≥n Mercado Pago (5%)</span>
                        <span id="commissionAmount"></span>
                    `;
                    // Insertar antes del total final
                    const finalRow = totalsDiv.querySelector('.order-total-row.final');
                    totalsDiv.insertBefore(commissionRow, finalRow);
                }
                document.getElementById('commissionAmount').textContent = formatMoney(commission);
            } else {
                if (commissionRow) {
                    commissionRow.remove();
                }
            }
            
            document.getElementById('total').textContent = formatMoney(total);
        }

        function processPayment() {
            const form = document.getElementById('checkoutForm');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // Validar que se haya seleccionado un m√©todo de env√≠o
            if (!selectedShippingMethod || shippingCost === 0) {
                alert('Por favor selecciona un m√©todo de env√≠o');
                return;
            }

            const country = document.getElementById('country').value;
            if (!country) {
                alert('Por favor selecciona un pa√≠s');
                return;
            }

            const formData = {
                fullName: document.getElementById('fullName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value,
                postalCode: document.getElementById('postalCode').value,
                country: country,
                shippingMethod: selectedShippingMethod,
                paymentMethod: selectedPaymentMethod,
                cart: cart
            };

            // Calcular total con env√≠o
            const subtotal = cart.reduce((sum, item) => {
                const prices = item.type === 'pack' 
                    ? getPricePerUnit(1, 'pack') 
                    : getPricePerUnit(item.quantity, 'product');
                return sum + (prices[currentCurrency] * item.quantity);
            }, 0);
            
            const commission = selectedPaymentMethod === 'MERCADOPAGO' ? subtotal * 0.05 : 0;
            const total = subtotal + shippingCost + commission;

            // Si es Nequi, Transferencia o Zelle, mostrar confirmaci√≥n
            if (selectedPaymentMethod === 'NEQUI' || selectedPaymentMethod === 'BANK' || selectedPaymentMethod === 'ZELLE') {
                const methodName = selectedPaymentMethod === 'NEQUI' ? 'Nequi' : selectedPaymentMethod === 'BANK' ? 'Transferencia Bancaria' : 'Zelle';
                const formatMoney = (amount) => {
                    if (currentCurrency === 'USD') {
                        return `$${amount.toFixed(2)} USD`;
                    } else {
                        return `$${Math.round(amount).toLocaleString('es-CO')} COP`;
                    }
                };
                
                const message = `
¬°Gracias por tu pedido!

Total a pagar: ${formatMoney(total)}
M√©todo de pago: ${methodName}

Por favor realiza el pago y env√≠a el comprobante al WhatsApp:
+57 300 123 4567

Incluye tu nombre completo: ${formData.fullName}
                `.trim();
                
                alert(message);
                
                // Opcional: redirigir a WhatsApp
                const whatsappMsg = encodeURIComponent(`Hola! Acabo de hacer un pedido.\n\nNombre: ${formData.fullName}\nEmail: ${formData.email}\nTotal: ${formatMoney(total)}\nM√©todo: ${methodName}\n\nEnv√≠o el comprobante de pago.`);
                window.open(`https://wa.me/573017606723?text=${whatsappMsg}`, '_blank');
                
                return;
            }

            // Si es Mercado Pago, continuar con el flujo normal
            if (selectedPaymentMethod === 'MERCADOPAGO') {
                createMercadoPagoCheckout(formData, total, subtotal + commission);
            }
        }

        async function createMercadoPagoCheckout(formData, total, subtotal) {
            // Mercado Pago Access Token - CAMBIAR POR TU TOKEN REAL
            // Para pruebas, puedes usar el access token de prueba desde tu cuenta
            const accessToken = 'TEST-TU_ACCESS_TOKEN_AQUI'; // Reemplazar con tu Access Token

            try {
                // Preparar items para Mercado Pago
                const items = cart.map(item => {
                    const prices = item.type === 'pack' 
                        ? getPricePerUnit(1, 'pack') 
                        : getPricePerUnit(item.quantity, 'product');
                    const unitPrice = prices[currentCurrency];
                    
                    return {
                        title: item.type === 'pack' 
                            ? `${item.name} (${item.products.map(p => p.id).join(', ')})` 
                            : item.name,
                        quantity: item.quantity,
                        unit_price: unitPrice,
                        currency_id: currentCurrency
                    };
                });

                // Agregar env√≠o como item
                items.push({
                    title: 'Env√≠o',
                    quantity: 1,
                    unit_price: shippingCost,
                    currency_id: currentCurrency
                });

                // Crear preferencia
                const preference = {
                    items: items,
                    payer: {
                        name: formData.fullName,
                        email: formData.email,
                        phone: {
                            area_code: '',
                            number: formData.phone
                        },
                        address: {
                            street_name: formData.address,
                            street_number: '',
                            zip_code: formData.postalCode
                        }
                    },
                    back_urls: {
                        success: window.location.origin + '/payment-response.html?status=success',
                        failure: window.location.origin + '/payment-response.html?status=failure',
                        pending: window.location.origin + '/payment-response.html?status=pending'
                    },
                    auto_return: 'approved',
                    external_reference: 'FRESCHE-' + Date.now(),
                    notification_url: window.location.origin + '/mercadopago-webhook',
                    statement_descriptor: 'FRESCHE'
                };

                // Llamar a tu backend para crear la preferencia de pago
                const response = await fetch(`${BACKEND_URL}/api/create-preference`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ preference, formData })
                });

                if (!response.ok) {
                    throw new Error('No se pudo crear la preferencia');
                }

                const data = await response.json();

                // Guardar datos del pedido localmente
                localStorage.setItem('orderData', JSON.stringify({
                    formData,
                    cart,
                    total,
                    subtotal,
                    shipping: shippingCost,
                    currency: currentCurrency,
                    date: new Date().toISOString()
                }));

                // Redirigir al checkout de Mercado Pago
                window.location.href = data.init_point;
                
            } catch (error) {
                console.error('Error al crear preferencia de Mercado Pago:', error);
                alert('Error al procesar el pago. Por favor int√©ntalo nuevamente.');
            }
        }

        // Cargar carrito al inicio
        window.addEventListener('DOMContentLoaded', () => {
            loadCart();
            // Inicializar instrucciones de pago
            const defaultPaymentMethod = document.querySelector('.payment-method.selected');
            if (defaultPaymentMethod) {
                selectPaymentMethod(defaultPaymentMethod);
            }
        });
    </script>
</body>
</html>
